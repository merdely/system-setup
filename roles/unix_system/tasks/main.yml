# unix_system tasks
---
- include_role: name=handlers
  when: handlers_role_imported is not defined
  tags: 'always'

- block:
    - block:
        - name: update apt cache
          apt:
            update_cache: true
            cache_valid_time: 3600
          become: true
          delay: 10
          register: result
          retries: 20
          until: result is not failed
      rescue:
        - name: log update apt cache failure
          set_fact:
            task_failures: '{{ task_failures | default([]) | union(["update apt cache (debian/main.yml)"]) }}'
          changed_when: true
          notify: list failed tasks

    - name: set vim as the default editor on debian
      copy:
        content: |
          # Generated by /usr/bin/select-editor
          SELECTED_EDITOR="/usr/bin/vim.basic"
        dest: '~/.selected_editor'
      tags: 'editor'
  when: ansible_os_family == 'Debian'

- name: print common packages needed for installation
  debug:
    msg: |
      {{ system_pkgs_install['common'] | default([])
         | union(system_pkgs_install[ansible_system] | default([]))
         | union(system_pkgs_install[ansible_os_family] | default([]))
      }}
  when: |
    system_pkgs_install['common'] | default([])
    | union(system_pkgs_install[ansible_system] | default([]))
    | union(system_pkgs_install[ansible_os_family] | default([])) | length > 0

- name: install common packages needed for installation
  package:
    name: |
      {{ system_pkgs_install['common'] | default([])
         | union(system_pkgs_install[ansible_system] | default([]))
         | union(system_pkgs_install[ansible_os_family] | default([]))
      }}
    state: 'present'
  become: true
  delay: 10
  register: result
  retries: 20
  until: result is not failed
  when: |
    system_pkgs_install['common'] | default([])
    | union(system_pkgs_install[ansible_system] | default([]))
    | union(system_pkgs_install[ansible_os_family] | default([])) | length > 0

- name: add common packages to install list
  set_fact:
    packages_to_install: |
      {{ packages_to_install | default([])
         | union(system_packages['common'] | default([]))
         | union(system_packages[ansible_system] | default([]))
         | union(system_packages[ansible_os_family] | default([]))
      }}
  changed_when: true
  notify:
    - update apt cache
    - update dnf cache
    - print packages_to_install
    - install packages
  tags: 'packages'

- name: determine if there are debian package updates  # noqa 306
  shell: 'apt-get -s upgrade | grep -qE "^[1-9][0-9]* upgraded"'
  args:
    warn: false
  changed_when: result.rc == 0
  failed_when: false
  notify: update packages
  register: result
  when: ansible_os_family == 'Debian'

- name: determine if there are redhat package updates  # noqa 306
  shell: 'dnf list --updates | grep -vE "^(Last metadata expiration|Available Upgrades)" | grep -q .'
  args:
    warn: false
  changed_when: result.rc == 0
  failed_when: false
  notify: update packages
  register: result
  when: ansible_os_family == 'RedHat'

- name: trigger openbsd package updates
  command: 'true'
  delegate_to: localhost
  changed_when: true
  notify: update packages
  when: ansible_os_family == 'OpenBSD'

- name: install custom files
  include_tasks: _custom_files.yml
  with_items: '{{ system_custom_files | default([]) }}'
  tags: 'customfiles'

- name: install custom includes
  include_tasks: _custom_includes.yml
  with_items: '{{ system_custom_includes | default([]) }}'
  tags: 'customincludes'

- name: install custom settings
  include_tasks: _custom_settings.yml
  with_items: '{{ system_custom_settings | default([]) }}'
  tags: 'customsettings'

- name: add custom repos
  include_tasks: _custom_repos.yml
  with_items: '{{ system_custom_repos | default([]) }}'
  tags: 'customrepos'

- name: add users to groups
  include_tasks: _custom_groups.yml
  with_items: '{{ system_custom_groups | default([]) }}'
  tags: 'customgroups'

- name: enable/start services
  include_tasks: _custom_services.yml
  with_items: '{{ system_custom_services | default([]) }}'
  tags: 'customservices'

- name: install custom deb files
  include_tasks: _custom_deb_files.yml
  with_items: '{{ system_custom_deb_files | default([]) }}'
  tags: 'debfiles'

- name: install custom certificates
  include_tasks: _install_custom_certs.yml
  with_items: '{{ custom_ssl_certs | default([]) }}'
  tags: 'cacert'

- name: 'include_tasks : {{ ansible_system }}.yml'
  include_tasks: '{{ ansible_system }}.yml'
  tags: 'always'
